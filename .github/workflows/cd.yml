name: CD

# ===========================================
# DEPLOYMENT
# ===========================================
# ğŸ”µ DEV  : Merge sur main â†’ VPS (api-dev) + Vercel Preview
# ğŸŸ¢ PROD : Tag v* â†’ VPS (api-prod) + Vercel Production
#
# Stack : Vercel (frontend) + VPS Hetzner (backend) + MongoDB Atlas

on:
  push:
    branches: [main]
    tags:
      - 'v*'

env:
  NODE_VERSION: '20'

jobs:
  # ==========================================
  # ğŸ”µ DEPLOY DEV
  # ==========================================
  deploy-dev:
    name: ğŸ”µ Deploy DEV
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment:
      name: dev
      url: ${{ vars.DEV_URL }}
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“š Install dependencies
        run: npm ci

      # ========================================
      # FRONTEND â†’ Vercel (Preview)
      # ========================================
      - name: ğŸ—ï¸ Build client (DEV)
        run: npm run build --workspace=client
        env:
          VITE_API_URL: ${{ vars.DEV_API_URL }}
          VITE_ENV: development

      - name: ğŸš€ Deploy Frontend to Vercel (Preview)
        uses: amondnet/vercel-action@v25
        id: vercel-dev
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./client

      # ========================================
      # BACKEND â†’ VPS via SSH
      # ========================================
      - name: ğŸš€ Deploy Backend to VPS (DEV)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd ~/apps/${{ github.event.repository.name }}
            git pull origin main
            docker compose build api-dev
            docker compose up -d api-dev
            docker image prune -f

      # ========================================
      # Summary
      # ========================================
      - name: ğŸ“ Deployment summary
        run: |
          echo "## ğŸ”µ DEV Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ steps.vercel-dev.outputs.preview-url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ vars.DEV_API_URL }} |" >> $GITHUB_STEP_SUMMARY

  # ==========================================
  # ğŸŸ¢ DEPLOY PROD
  # ==========================================
  deploy-prod:
    name: ğŸŸ¢ Deploy PROD
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    environment:
      name: prod
      url: ${{ vars.PROD_URL }}
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“š Install dependencies
        run: npm ci

      # ========================================
      # FRONTEND â†’ Vercel (Production)
      # ========================================
      - name: ğŸ—ï¸ Build client (PROD)
        run: npm run build --workspace=client
        env:
          VITE_API_URL: ${{ vars.PROD_API_URL }}
          VITE_ENV: production

      - name: ğŸš€ Deploy Frontend to Vercel (Production)
        uses: amondnet/vercel-action@v25
        id: vercel-prod
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: ./client

      # ========================================
      # BACKEND â†’ VPS via SSH
      # ========================================
      - name: ğŸš€ Deploy Backend to VPS (PROD)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd ~/apps/${{ github.event.repository.name }}
            git fetch --tags
            git checkout ${{ github.ref_name }}
            docker compose build api-prod
            docker compose up -d api-prod
            docker image prune -f

      # ========================================
      # Summary
      # ========================================
      - name: ğŸ“ Deployment summary
        run: |
          echo "## ğŸŸ¢ PROD Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ vars.PROD_URL }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ vars.PROD_API_URL }} |" >> $GITHUB_STEP_SUMMARY

  # ==========================================
  # ğŸ“¦ CREATE RELEASE
  # ==========================================
  release:
    name: ğŸ“¦ Create Release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    needs: deploy-prod
    permissions:
      contents: write
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¦ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') }}
          body: |
            ## ğŸš€ Release ${{ github.ref_name }}
            
            ### Stack
            - ğŸ–¥ï¸ **Frontend:** Vercel
            - âš™ï¸ **Backend:** VPS Hetzner (Docker)
            - ğŸ—„ï¸ **Database:** MongoDB Atlas
            
            ### URLs
            - ğŸŸ¢ **Production:** ${{ vars.PROD_URL }}
            - ğŸ”µ **Dev:** ${{ vars.DEV_URL }}
